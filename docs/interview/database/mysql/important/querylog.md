# MySQL 慢查询日志

你是否有过这样的经历，当你在使用 MySQL 数据库时，发现有些查询语句执行得非常慢，甚至影响了整个系统的性能？你是否想知道为什么这些查询语句会这么慢，以及如何优化它们呢？如果你的答案是肯定的，那么本文就是为你准备的。

本文将介绍 MySQL 慢查询日志的概念、作用、配置和分析方法，以及一些常见的慢查询优化方式。希望通过本文的阅读，你能够对 MySQL 慢查询有一个更深入的了解，以及掌握一些实用的优化技巧。

## 慢查询日志是什么？

MySQL 慢查询日志（Slow Query Log）是 MySQL 提供的一种日志记录功能，用来记录在 MySQL 中执行时间超过指定阈值的 SQL 语句。通过慢查询日志，我们可以找出哪些 SQL 语句的执行效率低，以便进行优化。

默认情况下，MySQL 并没有开启慢查询日志，我们需要通过修改 `slow_query_log` 参数来打开慢查询日志。与慢查询日志相关的参数有以下几个：

- `slow_query_log`：是否启用慢查询日志，默认为 **OFF**，可设置为 OFF 或 ON，ON 表示开启
- `slow_query_log_file`：指定慢查询日志位置及名称，默认值为**host_name-slow.log**，可指定绝对路径
- `long_query_time`：慢查询执行时间阈值，超过此时间会记录，默认为**10**，单位为秒
- `log_output`：慢查询日志输出目标，默认为**file**，即输出到文件
- `log_timestamps`：主要是控制 error log、slow log、general log 日志文件中的显示时区，默认为**UTC**，建议改为 **SYSTEM**，即系统时区
- `log_queries_not_using_indexes`：是否记录所有未使用索引的查询语句，默认为 **OFF**
- `min_examined_row_limit`：对于查询扫描行数小于此参数的 SQL，将不会记录到慢查询日志中，默认为 **0**。
- `log_slow_admin_statements`：慢速管理语句是否写入慢日志中，管理语句包含 alter table、create index 等，默认为 **OFF**，即不写入。

一般情况下，我们只需开启慢日志记录，配置下阈值时间，其余参数可按默认配置。对于阈值时间，可灵活调整，比如说可以设置为 1 秒或 3 秒。如下：

```text
# 配置文件
[MySQLd]
slow_query_log = 1 # 开启慢查询日志
slow_query_log_file = /data/MySQL/logs/slow.log # 指定慢查询日志文件位置和名称
long_query_time = 1 # 指定慢查询阈值为1秒
log_timestamps = SYSTEM # 指定慢查询日志时间戳为系统时区
log_output = FILE # 指定慢查询日志输出目标为文件

# 执行SQL语句
set global slow_query_log = 1; # 开启慢查询日志
set global slow_query_log_file = '/data/MySQL/logs/slow.log'; # 指定慢查询日志文件位置和名称
set global long_query_time = 1; # 指定慢查询阈值为1秒
set global log_timestamps = SYSTEM; # 指定慢查询日志时间戳为系统时区
set global log_output = FILE; # 指定慢查询日志输出目标为文件
```

这样，我们就可以在 `/var/log/MySQL/slow.log` 文件中查看慢查询日志了。

## 如何分析慢查询日志？

当我们开启了慢查询日志后，我们就可以查看慢查询日志文件中的内容。每条慢查询记录都以 # 字符开头。例如：

```text
# Time: 2021-06-09T10:42:33.687811+08:00
# User@Host: root [root] @ [192.168.85.0] Id: 2604943
# Query_time: 1.099889 Lock_time: 0.000144 Rows_sent: 39 Rows_examined: 45305
SET timestamp=1620898683;
select * from test_table where col_name like '%测试%';
```

从上面的例子中，我们可以看到每条慢查询日志都包含以下几个部分：

- `Time`：SQL语句执行的时刻
- `User@Host`：执行SQL语句的用户和主机
- `Query_time`：SQL语句执行时间，以秒为单位
- `Lock_time`：获取锁的时间，以秒为单位
- `Rows_sent`：发送给客户端的行数
- `Rows_examined`：服务器层检查的行数
- `timestamp`：SQL语句执行时的时间戳
- SQL语句本身

通过查看慢查询日志，我们可以发现哪些 SQL 语句执行时间过长，以及可能的原因。

 - `Query_time`（SQL语句执行时间）过长，可能是因为SQL语句本身有问题，或者数据量太大，或者服务器负载太高等原因
 - `Lock_time`（获取锁的时间）过长，可能是因为存在锁竞争，或者锁粒度太大，或者事务隔离级别太高等原因
 - `Rows_sent`（发送给客户端的行数）过多，可能是因为SQL语句没有加上合适的条件或者限制，导致返回了不必要的数据
 - `Rows_examined`（服务器层检查的行数）过多，可能是因为SQL语句没有使用到合适的索引，导致全表扫描或者范围扫描

> ps:对于慢查询日志文件，要定期进行归档处理，比如可以暂时关闭慢日志，然后将旧文件重命名，之后再开启慢日志，这样就会写入新的日志文件中，有效减小日志体积。

### 如何分析SQL？
分析SQL的方法有很多，这里只介绍一些常用的：

- 使用 `EXPLAIN` 命令查看 SQL 语句的执行计划，了解它们是如何使用索引和连接表的。
- 使用 `SHOW PROFILE` 命令查看 SQL 语句的执行细节，了解它们在各个阶段花费了多少时间。
- 使用 `SHOW STATUS` 命令查看 MySQL 的运行状态，了解它们是否有资源不足或竞争过高的情况。
- 借助第三方工具，例如
    - 使用MySQLdumpslow：这是 MySQL 自带的一个工具，可以对慢查询日志进行汇总和排序，按照不同的维度展示慢查询信息。例如，我们可以使用 `MySQLdumpslow -s t -t 10 slow.log` 命令来显示执行时间最长的 10 条慢查询。
    - 使用pt-query-digest：这是 Percona Toolkit 提供的一个工具，功能比 MySQLdumpslow 更强大，可以对慢查询日志进行详细的分析和报告，提供各种统计信息和优化建议。例如，我们可以使用 `pt-query-digest slow.log` 命令来生成一个完整的慢查询分析报告。 

### 如何优化 MySQL 慢查询？

如果发现有不合理的索引或连接方式，可以考虑修改 SQL 语句或添加合适的索引。
如果发现有某个阶段耗时过长，可以考虑优化该阶段的操作。
如果发现有问题，可以考虑调整 MySQL 的参数或增加硬件资源。


当我们发现了一些慢查询语句后，我们就需要对它们进行优化。优化 MySQL 慢查询的方法有很多种，这里只介绍一些常见的方法。

#### 使用索引

索引是提高 MySQL 查询效率的最常用也最有效的方法。索引可以让 MySQL 快速定位到需要查询或更新的数据，避免全表扫描或排序操作。MySQL 支持多种类型的索引，如 B-Tree 索引、Hash 索引、全文索引等。创建合适的索引可以极大地提升查询性能。

但是，并不是所有的字段都适合创建索引。创建索引也有一些代价和限制。例如：

- 索引会占用额外的磁盘空间。
- 索引会增加插入、更新、删除操作的开销。
- 索引只有在满足一定条件时才会起作用。

因此，在创建索引时，我们需要考虑以下几个因素：

- 字段是否经常作为查询条件或排序条件。
- 字段是否具有较高的区分度（即不同值占总数的比例）。
- 字段是否为数值类型或短字符串类型（这些类型占用空间小，比较快）。
- 字段是否需要联合索引（即多个字段组成一个索引）。

#### 分解关联查询

将一个大的关联查询分解为多个小查询是很有必
